--[[
    ü§ñ UTD PRO BOT - V4 (Lobby/Game Fixed)
    Author: Jem (AI)
    GitHub Ready
]]

-- CONFIGURATION
local CONFIG = {
    MacroFile = "UTD_Macro_1.json",      
    ReplayFile = "UTD_ReplayCount.txt",  
    MaxReplays = 4,                      
    LobbyPlaceID = 5902977746,           
    
    -- ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏ó‡πà‡∏ô‡∏ß‡∏≤‡∏õ‡πÉ‡∏ô LOBBY (‡∏ß‡∏á‡πÅ‡∏î‡∏á)
    LobbyWarpPad = Vector3.new(11187, 23, 59),
    
    -- ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏∏‡∏î‡∏¢‡∏∑‡∏ô‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÉ‡∏ô DUNGEON (‡∏ó‡∏µ‡πà‡∏û‡∏µ‡πà‡∏Ç‡∏≠‡∏°‡∏≤)
    FarmPosition = Vector3.new(-140, -87, -168) 
}

-- SERVICES
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local TeleportService = game:GetService("TeleportService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")

------------------------------------------------------
-- üñ•Ô∏è GUI SYSTEM
------------------------------------------------------
local GUI = {}
function GUI.Create()
    if CoreGui:FindFirstChild("JemBotUI") then CoreGui.JemBotUI:Destroy() end
    local ScreenGui = Instance.new("ScreenGui"); ScreenGui.Name = "JemBotUI"; ScreenGui.Parent = CoreGui
    local Frame = Instance.new("Frame"); Frame.Name = "MainFrame"; Frame.Size = UDim2.new(0, 300, 0, 120); Frame.Position = UDim2.new(0.5, -150, 0.1, 0); Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30); Frame.Active = true; Frame.Draggable = true; Frame.Parent = ScreenGui
    local Title = Instance.new("TextLabel"); Title.Text = "ü§ñ UTD BOT V4 (Stable)"; Title.Size = UDim2.new(1,0,0,30); Title.BackgroundColor3 = Color3.fromRGB(46, 204, 113); Title.TextColor3 = Color3.new(1,1,1); Title.Parent = Frame
    local Status = Instance.new("TextLabel"); Status.Name = "Status"; Status.Text = "..."; Status.Size = UDim2.new(1,-20,0,30); Status.Position = UDim2.new(0,10,0,40); Status.TextColor3 = Color3.fromRGB(255,200,0); Status.Parent = Frame
    local Round = Instance.new("TextLabel"); Round.Name = "Round"; Round.Text = "..."; Round.Size = UDim2.new(1,-20,0,30); Round.Position = UDim2.new(0,10,0,70); Round.TextColor3 = Color3.fromRGB(200,200,200); Round.Parent = Frame
    return {Status = Status, Round = Round}
end
local UI_Elements = GUI.Create()
function GUI.SetStatus(t) if UI_Elements.Status then UI_Elements.Status.Text = "Status: "..t end print("ü§ñ "..t) end
function GUI.SetRound(c, m) if UI_Elements.Round then UI_Elements.Round.Text = "Replay: "..c.." / "..m end end

------------------------------------------------------
-- üíæ SYSTEM
------------------------------------------------------
local function GetReplayCount() return isfile(CONFIG.ReplayFile) and tonumber(readfile(CONFIG.ReplayFile)) or 0 end
local function SetReplayCount(n) writefile(CONFIG.ReplayFile, tostring(n)); GUI.SetRound(n, CONFIG.MaxReplays) end

local function PlayMacro()
    if not isfile(CONFIG.MacroFile) then GUI.SetStatus("‚ùå No Macro File!"); return end
    local data = HttpService:JSONDecode(readfile(CONFIG.MacroFile))
    GUI.SetStatus("‚ñ∂ Playing Macro ("..#data.." steps)...")
    task.spawn(function()
        local start = os.clock()
        for i, v in ipairs(data) do
            local delay = v.Time - (os.clock() - start)
            if delay > 0 then task.wait(delay) end
            if i%10==0 then GUI.SetStatus("‚ñ∂ Progress: "..math.floor((i/#data)*100).."%") end
            if v.Type == "Key" then VirtualInputManager:SendKeyEvent(v.IsDown, Enum.KeyCode[v.Code] or v.Code, false, game)
            elseif v.Type == "Mouse" then VirtualInputManager:SendMouseButtonEvent(v.X, v.Y, 0, v.IsDown, game, 1) end
        end
        GUI.SetStatus("‚úÖ Macro Done! Waiting end...")
    end)
end

local function TriggerReplay()
    GUI.SetStatus("üîÑ Replaying...")
    local remote = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("GlobalInit"):WaitForChild("RemoteEvents"):WaitForChild("PlayerVoteReplay", 5)
    if remote then remote:FireServer() else GUI.SetStatus("‚ùå No Replay Remote") end
end

------------------------------------------------------
-- üìç LOCATION CHECK (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç V4)
------------------------------------------------------
local function IsInLobby()
    -- ‡πÄ‡∏ä‡πá‡∏Å‡∏ï‡∏≤‡∏° Path ‡∏ó‡∏µ‡πà‡∏û‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤‡πÄ‡∏õ‡πä‡∏∞‡πÜ
    if workspace:FindFirstChild("Lobby") then
        return true
    end
    return false
end

------------------------------------------------------
-- üè† LOBBY LOGIC
------------------------------------------------------
local function HandleLobby(root)
    GUI.SetStatus("üè† LOBBY MODE ACTIVATED")
    SetReplayCount(0)
    
    task.wait(2)
    local dist = (root.Position - CONFIG.LobbyWarpPad).Magnitude
    
    if dist > 10 then
        GUI.SetStatus("üöÄ Walking to Event Portal...")
        -- ‡∏ß‡∏≤‡∏õ‡πÑ‡∏õ‡∏à‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ß‡∏á‡πÅ‡∏î‡∏á‡πÄ‡∏•‡∏¢
        root.CFrame = CFrame.new(CONFIG.LobbyWarpPad + Vector3.new(0, 3, 0))
    else
        GUI.SetStatus("‚úÖ Already at Portal")
    end
    
    for i = 20, 1, -1 do GUI.SetStatus("‚è≥ Waiting for Teleport: "..i.."s"); task.wait(1) end
    GUI.SetStatus("üîî Game should start soon...")
end

------------------------------------------------------
-- ‚öîÔ∏è GAME LOGIC
------------------------------------------------------
local function HandleGame(root)
    GUI.SetStatus("‚öîÔ∏è DUNGEON MODE ACTIVATED")
    local round = GetReplayCount()
    GUI.SetRound(round, CONFIG.MaxReplays)
    
    -- 1. ‡∏ß‡∏≤‡∏õ‡πÑ‡∏õ‡∏à‡∏∏‡∏î‡∏ü‡∏≤‡∏£‡πå‡∏° (-140, -87, -168)
    local distToFarm = (root.Position - CONFIG.FarmPosition).Magnitude
    
    if distToFarm > 5 then
        GUI.SetStatus("üöÄ Warping to Farm Spot...")
        task.wait(0.5)
        root.CFrame = CFrame.new(CONFIG.FarmPosition)
        task.wait(1.5) -- ‡∏£‡∏≠‡∏ï‡∏±‡∏ß‡∏ô‡∏¥‡πà‡∏á + ‡πÅ‡∏°‡∏û‡πÇ‡∏´‡∏•‡∏î
    else
        GUI.SetStatus("‚úÖ At Farm Spot")
    end

    -- 2. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏≤‡πÇ‡∏Ñ‡∏£
    GUI.SetStatus("‚ñ∂ Starting Macro...")
    PlayMacro()
    
    -- 3. ‡∏£‡∏≠‡∏à‡∏ö‡πÄ‡∏Å‡∏°
    task.wait(20) 
    
    if round < CONFIG.MaxReplays then
        GUI.SetStatus("üî• Next Round: " .. (round + 1))
        SetReplayCount(round + 1)
        TriggerReplay()
    else
        GUI.SetStatus("üõë Finished! Returning Lobby...")
        SetReplayCount(0)
        TeleportService:Teleport(CONFIG.LobbyPlaceID, LocalPlayer)
    end
end

------------------------------------------------------
-- üèÅ START
------------------------------------------------------
GUI.SetStatus("‚è≥ Analyzing Map...")
if not game:IsLoaded() then game.Loaded:Wait() end

local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local root = char:WaitForChild("HumanoidRootPart", 30)

if root then
    -- ‡πÄ‡∏ä‡πá‡∏Å‡πÅ‡∏ö‡∏ö‡∏ä‡∏±‡∏ß‡∏£‡πå 100% ‡∏î‡πâ‡∏ß‡∏¢ Path ‡∏ó‡∏µ‡πà‡∏û‡∏µ‡πà‡∏´‡∏≤‡∏°‡∏≤
    if IsInLobby() then
        HandleLobby(root)
    else
        HandleGame(root)
    end
end
